<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinosoft.etp.cp.curriculum.mapper.TCurriculumStudentWithCpMapper">

    <resultMap type="tCurriculumStudentWithCp" id="SysUserResult">
        <id     property="userId"       column="user_id"      />
        <result property="kcid"         column="kcid"      />
        <result property="xyid"         column="xyid"      />
        <result property="jd"           column="jd"      />
        <result property="deptId"       column="dept_id"      />
        <result property="userName"     column="user_name"    />
        <result property="nickName"     column="nick_name"    />
        <result property="email"        column="email"        />
        <result property="phonenumber"  column="phonenumber"  />
        <result property="sex"          column="sex"          />
        <result property="avatar"       column="avatar"       />
        <result property="password"     column="password"     />
        <result property="status"       column="status"       />
        <result property="delFlag"      column="del_flag"     />
        <result property="loginIp"      column="login_ip"     />
        <result property="loginDate"    column="login_date"   />
        <result property="createBy"     column="create_by"    />
        <result property="createTime"   column="create_time"  />
        <result property="updateBy"     column="update_by"    />
        <result property="updateTime"   column="update_time"  />
        <result property="remark"       column="remark"       />
        <association property="dept"    column="dept_id" javaType="SysDept" resultMap="deptResult" />
        <collection  property="roles"   javaType="java.util.List"        resultMap="RoleResult" />
    </resultMap>

    <resultMap id="deptResult" type="SysDept">
        <id     property="deptId"   column="dept_id"     />
        <result property="parentId" column="parent_id"   />
        <result property="deptName" column="dept_name"   />
        <result property="orderNum" column="order_num"   />
        <result property="leader"   column="leader"      />
        <result property="status"   column="dept_status" />
    </resultMap>

    <resultMap id="RoleResult" type="SysRole">
        <id     property="roleId"       column="role_id"        />
        <result property="roleName"     column="role_name"      />
        <result property="roleKey"      column="role_key"       />
        <result property="roleSort"     column="role_sort"      />
        <result property="dataScope"     column="data_scope"    />
        <result property="status"       column="role_status"    />
    </resultMap>

    <sql id="selectUserVo">
        select u.user_id, u.dept_id, u.user_name, u.nick_name, u.email, u.avatar, u.phonenumber, u.sex, u.status, u.del_flag,
               u.login_ip, u.login_date, u.create_by, u.create_time, u.remark,
               ts.jd,ts.kcid,ts.xyid
        from sys_user u

    </sql>

    <insert id="insert" parameterType="tCurriculumStudentWithCp">
        INSERT INTO  t_curriculum_student(kcid,xyid,create_time,update_time) VALUES
        <foreach collection="list" item="item" index="key" separator=",">
            ( #{item.kcid}, #{item.xyid},sysdate(),sysdate())
        </foreach>
    </insert>


    <select id="selectByKcId" resultMap="SysUserResult">
        <include refid="selectUserVo" />
        JOIN  t_curriculum_student ts  ON u.user_id = ts.xyid
        WHERE ts.del_flag = '0' and u.del_flag = '0'
        AND ts.kcid = #{kcid}
    </select>

    <select id="selectStudnetByKcIdAndXYid"  resultMap="SysUserResult">
        <include refid="selectUserVo" />
        JOIN  t_curriculum_student ts  ON u.user_id = ts.xyid
        WHERE ts.del_flag = '0' and u.del_flag = '0'
        AND ts.kcid = #{kcid} and ts.xyid=#{xyid}
    </select>

    <delete id="delRealtionByKcId">

        <!--
            update t_curriculum_student
            set del_flag = '1'
            where kcid =#{kcid}
            更改为物理删除
        -->
        DELETE FROM t_curriculum_student where kcid =#{kcid}

    </delete>



<!--   ********************统计分析******************************-->
<!--    课程完成总的用户数-->
    <select id="getAllCompletedKcUser" resultType="integer">
        select
            count(1)
        from t_curriculum_student
        <where>
            del_flag= '0'
            <if test="kcid != null  and kcid != ''"> and kcid = #{kcid}</if>
            and jd->'$.rate'=100
        </where>
    </select>

<!--    近七日课程完成人数-->
    <select id="getCompletedKcUserByDate" resultType="Map">
        select
            count(1) num,
            DATE_FORMAT(update_time, '%Y-%m-%d') as "date"
        from t_curriculum_student
        <where>
            del_flag= '0'
            <if test="kcid != null  and kcid != ''"> and kcid = #{kcid}</if>
            and jd->'$.time' > #{startTime}
            and jd->'$.time' &lt; #{endTime}
            and jd->'$.rate'=100
        </where>
        GROUP BY DATE_FORMAT(update_time, '%Y-%m-%d')
    </select>

<!-- 课件总计已完成-->
   <select id="getCompletedCourse" resultType="integer">
       SELECT
           count( 1 )
       FROM
           t_courseware_student
       WHERE
           jd -> '$.rate' = 100
           AND kjid IN ( SELECT sid FROM t_curriculum_content WHERE source_type = 'kj' AND cid = #{kcid} )
   </select>

    <!-- 已领取课程用户数-->
    <select id="getReceivedKcUser" resultType="integer">
        select
        count(1)
        from t_curriculum_student
        <where>
            del_flag= '0'
            <if test="kcid != null  and kcid != ''"> and kcid = #{kcid}</if>
        </where>
    </select>

<!--    昨日学习课程用户数-->
    <select id="getYesterdayStudyKc" resultType="integer">
        select
            count(1)
        from t_curriculum_student
        <where>
            del_flag= '0'
            and jd is not NULL
            and FROM_UNIXTIME(jd->'$.time'/1000,"%Y-%m-%d" ) = DATE_SUB(CURDATE(),INTERVAL 1 DAY)
            <if test="kcid != null  and kcid != ''"> and kcid = #{kcid}</if>
        </where>
    </select>

<!--    课程总计包含课件数-->
    <select id="getCourseNum" resultType="integer">
        SELECT count(1)
        FROM
        t_curriculum_content
        <where>
            source_type= 'kj'
            <if test="kcid != null  and kcid != ''"> and cid = #{kcid}</if>
        </where>
    </select>
<!--  课程各课件完成情况-->
    <select id="getCompletedKjByDate" resultType="map">

        select a.id,a.mc,
        <foreach item="date" collection="dates" separator=",">
            sum(case when a.date=#{date} then num else 0 end ) as #{date}
        </foreach>
        from
            (SELECT
                 DATE_FORMAT( ts.update_time, '%Y-%m-%d' ) AS "date",
                 t.id,
                 t.mc,
                 count( 1 ) AS num
             FROM
                t_courseware t
                LEFT JOIN t_courseware_student ts ON ts.kjid = t.id and ts.jd -> '$.rate' = 100 and ts.update_time > #{startTime}
               and ts.update_time &lt; #{endTime}
             WHERE
                t.id IN (
                    SELECT sid
                    FROM t_curriculum_content
                    <where> source_type = 'kj'
                        <if test="kcid != null  and kcid != ''"> and cid = #{kcid}</if>
                    </where>
            )
             GROUP BY
                 date,
                 t.id) a
        group by id,mc


    </select>
<!--    课程课件完成数量 统计分析-->
    <select id="getCompletedKcKjDate" resultType="map">
        select a.id,a.mc,
        <foreach item="date" collection="dates" separator=",">
            sum(case when a.date=#{date} then num else 0 end ) as #{date}
        </foreach>
        from
        (
            select DATE_FORMAT( tcs.update_time, '%Y-%m-%d' ) AS "date",t.id,t.mc,count(1) num
            from t_curriculum t
            left join t_curriculum_content tc on t.id =tc.cid and tc.source_type='kj'
            left join t_courseware_student tcs on tc.sid = tcs.kjid
            where tcs.jd -> '$.rate' = 100
                AND tcs.update_time > #{startTime}
                AND tcs.update_time &lt; #{endTime}
        GROUP BY
        date,
        t.id)a
        GROUP BY
        id
    </select>
<!--    已发布课程数-->
    <select id="getFbCurriculum" resultType="integer">
        select count(1)
        from t_curriculum
        where
            del_flag='0'
            and states='99'
    </select>

</mapper>

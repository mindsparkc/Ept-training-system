<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.sinosoft.etp.cp.examination.mapper.TExaminationStudentWithCpMapper">
    <resultMap type="tExaminationStudentWithCp" id="SysUserResult">
        <id     property="userId"       column="user_id"      />
        <result property="ksid"         column="ksid"      />
        <result property="xyid"         column="xyid"      />
        <result property="jd"           column="jd"      />
        <result property="score"           column="score"      />
        <result property="rate"           column="rate"      />
        <result property="pjzt"         column="pjzt"         />
        <result property="deptId"       column="dept_id"      />
        <result property="userName"     column="user_name"    />
        <result property="nickName"     column="nick_name"    />
        <result property="email"        column="email"        />
        <result property="phonenumber"  column="phonenumber"  />
        <result property="sex"          column="sex"          />
        <result property="avatar"       column="avatar"       />
        <result property="password"     column="password"     />
        <result property="status"       column="status"       />
        <result property="delFlag"      column="del_flag"     />
        <result property="loginIp"      column="login_ip"     />
        <result property="loginDate"    column="login_date"   />
        <result property="handTime"     column="hand_time"    />
        <result property="createBy"     column="create_by"    />
        <result property="createTime"   column="create_time"  />
        <result property="updateBy"     column="update_by"    />
        <result property="updateTime"   column="update_time"  />
        <result property="remark"       column="remark"       />
        <association property="dept"    column="dept_id" javaType="SysDept" resultMap="deptResult" />
        <collection  property="roles"   javaType="java.util.List"        resultMap="RoleResult" />
    </resultMap>

    <resultMap id="deptResult" type="SysDept">
        <id     property="deptId"   column="dept_id"     />
        <result property="parentId" column="parent_id"   />
        <result property="deptName" column="dept_name"   />
        <result property="orderNum" column="order_num"   />
        <result property="leader"   column="leader"      />
        <result property="status"   column="dept_status" />
    </resultMap>

    <resultMap id="RoleResult" type="SysRole">
        <id     property="roleId"       column="role_id"        />
        <result property="roleName"     column="role_name"      />
        <result property="roleKey"      column="role_key"       />
        <result property="roleSort"     column="role_sort"      />
        <result property="dataScope"     column="data_scope"    />
        <result property="status"       column="role_status"    />
    </resultMap>

    <resultMap type="TExaminationInfoWithCp" id="TExaminationInfo">
        <id     property="id"       column="id"      />
        <result property="userId"         column="user_id"      />
        <result property="ksid"         column="ksid"      />
        <result property="xyid"         column="xyid"      />
        <result property="jd"           column="jd"      />
        <result property="score"           column="score"      />
        <result property="rate"           column="rate"      />
        <result property="pjzt"         column="pjzt"         />
        <result property="userName"     column="user_name"    />
        <result property="nickName"     column="nick_name"    />
        <result property="email"        column="email"        />
        <result property="phonenumber"  column="phonenumber"  />
        <result property="sex"          column="sex"          />
        <result property="avatar"       column="avatar"       />
        <result property="password"     column="password"     />
        <result property="status"       column="status"       />
        <result property="delFlag"      column="del_flag"     />
        <result property="loginIp"      column="login_ip"     />
        <result property="loginDate"    column="login_date"   />
        <result property="handTime"     column="hand_time"    />
        <result property="createBy"     column="create_by"    />
        <result property="createTime"   column="create_time"  />
        <result property="updateBy"     column="update_by"    />
        <result property="updateTime"   column="update_time"  />
        <result property="remark"       column="remark"       />
        <result property="handType"       column="hand_type"       />
        <result property="pjTeacher"       column="pj_teacher"       />
        <result property="pjTime"       column="pj_time"       />
    </resultMap>

    <sql id="selectUserVo">
        select u.user_id, u.dept_id, u.user_name, u.nick_name, u.email, u.avatar, u.phonenumber, u.sex, u.status, u.del_flag,
               u.login_ip, u.login_date, u.create_by, u.create_time, u.remark,
               ts.jd,ts.ksid,ts.xyid,ts.rate,ts.score
        from sys_user u

    </sql>
    <insert id="insert" parameterType="tExaminationStudentWithCp">
        INSERT INTO  t_examination_student(ksid,xyid,jd,create_time,update_time) VALUES
        <foreach collection="list" item="item" index="key" separator=",">
            ( #{item.ksid}, #{item.xyid},#{item.jd},sysdate(),sysdate())
        </foreach>
    </insert>


    <select id="selectByKsId" resultMap="SysUserResult">
        <include refid="selectUserVo" />
        JOIN  t_examination_student ts  ON u.user_id = ts.xyid
        WHERE ts.del_flag = '0' and u.del_flag = '0'
        AND ts.ksid = #{ksid}
    </select>

    <select id="selectMissExamByKsId" resultMap="SysUserResult">
        <include refid="selectUserVo" />
        JOIN  t_examination_student ts  ON u.user_id = ts.xyid
        WHERE ts.del_flag = '0' and u.del_flag = '0'
        AND ts.ksid = #{ksid} and ts.ksid not in (select ksid from t_testpaper_student)
    </select>

    <select id="selectInfo" resultMap="TExaminationInfo">
        SELECT
            t.id,
            t.jd,
            t.ksid,
            t.xyid,
            t.score,
            t.rate,
            t.pjzt,
            t.create_time,
            t.hand_time,
            t.pj_time,
            t.pj_teacher,
            t.da,
            s.user_id,
            s.user_name,
            s.nick_name,
            s.email,
            s.phonenumber,
            s.sex
        FROM
            t_testpaper_student t
            LEFT JOIN sys_user s
            on t.xyid=s.user_id
        where t.del_flag=0 and t.hand_time is not null and t.ksid = #{ksid}
        <if test="pjzt != '' and pjzt != null">and t.pjzt = #{pjzt}</if>
        <if test="pjzt == ''">and t.pjzt is null</if>
    </select>
    <select id="selectKsCount" resultType="java.lang.Integer">
        SELECT
            count(t.id)
        FROM
            t_testpaper_student t
            LEFT JOIN sys_user s
            on t.xyid=s.user_id
        where t.del_flag=0
        and t.hand_type!=0
        and t.ksid = #{ksid}
    </select>

    <delete id="delRealtionByKsId">
        <!--
        update t_examination_student
        set del_flag = '1'
        where ksid =#{ksid}
        更改为物理删除
        -->
        DELETE FROM t_examination_student where ksid =#{ksid}
    </delete>


    <select id="selectExamInfo" resultMap="TExaminationInfo">
        SELECT
        t.id,
        t.xyid,
        t.score,
        t.rate,
        t.pjzt,
        t.create_time,
        t.pj_time,
        t.hand_time,
        t.hand_type,
        s.user_id,
        s.user_name,
        s.nick_name
        FROM
        t_testpaper_student t
        LEFT JOIN sys_user s
        on t.xyid=s.user_id
        where t.del_flag=0 and t.hand_time is not null and t.ksid = #{ksid}
    </select>
</mapper>
